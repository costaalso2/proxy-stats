<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Proxy Monitor Pro</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: white; text-align: center; padding: 20px; }
    .card { background: #161616; padding: 25px; border-radius: 20px; display: inline-block; width: 95%; max-width: 350px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .progress-bg { background: #333; border-radius: 15px; height: 30px; margin: 20px 0; overflow: hidden; border: 1px solid #444; }
    #bar { background: linear-gradient(90deg, #00c853, #b2ff59); height: 100%; width: 0%; transition: width 1.5s ease; }
    .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
    button { cursor: pointer; background: #222; color: white; border: 1px solid #444; padding: 8px 15px; border-radius: 12px; font-size: 13px; transition: 0.3s; }
    button.active { border-color: #00c853; background: #0f2b1a; }
    .info-list { text-align: left; font-size: 14px; color: #bbb; margin-top: 20px; line-height: 1.8; }
    select { background: #222; color: white; border: 1px solid #444; border-radius: 5px; padding: 3px; }
    textarea { width: 100%; margin-top: 10px; background: #111; color: #0f0; border: 1px solid #444; border-radius: 8px; padding: 10px; font-size: 12px; }
    input.token { width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #444; background: #111; color: #fff; margin-top: 8px; }
    .small { font-size: 12px; color: #999; margin-top: 8px; }
  </style>
</head>
<body>

<div class="card">
  <h2 id="percent-text">Cargando...</h2>
  <div class="progress-bg"><div id="bar"></div></div>
  <div id="usage-text" style="font-size: 18px; font-weight: bold;">0 MB / 1024 MB</div>

  <div class="info-list">
    <div>憋 <span id="label-upd">Actualizaci贸n</span>: 
      <select id="speed" onchange="resetTimer()">
        <option value="60000">Cada 60s</option>
        <option value="30000">Cada 30s</option>
      </select>
    </div>
    <div> <span id="label-req">Solicitudes</span>: <span id="req-val">--</span></div>
    <div> <span id="label-proj">Proyecci贸n</span>: <span id="proj-val">--</span></div>
  </div>

  <div class="btn-group">
    <button id="mode-btn" onclick="toggleMode()" class="active">Modo: Real</button>
    <button id="lang-btn" onclick="toggleLang()"> Idioma: Espa帽ol</button>
  </div>

  <!-- Token input -->
  <div style="margin-top: 18px; text-align: left;">
    <label class="small">Webshare API Token (no lo incluyas en commits)</label>
    <input id="token-input" class="token" placeholder="Pega tu token aqu铆" />
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button onclick="saveToken()">Guardar token</button>
      <button onclick="clearToken()">Eliminar token</button>
    </div>
    <div id="token-hint" class="small">Token guardado: <span id="token-status">no</span></div>
  </div>

  <!-- Nueva secci贸n para lista de proxies -->
  <div style="margin-top: 20px;">
    <button onclick="mostrarLista()" id="view-list-btn"> Ver lista de proxies</button>
    <button onclick="descargarLista()" id="download-list-btn"> Descargar como archivo</button>
    <textarea id="proxy-output" rows="6" placeholder="Aqu铆 aparecer谩n tus proxies..."></textarea>
  </div>
</div>

<script>
  // Token is no longer hard-coded. Store it in localStorage instead.
  let isEn = false;
  let isDemo = false;
  let timer;

  const lang = {
    es: { used: "Usado", upd: "Actualizaci贸n", req: "Solicitudes", proj: "Proyecci贸n", real: "Modo: Real", demo: "Modo: Demo", lang: "Idioma: Espa帽ol" },
    en: { used: "Used", upd: "Update", req: "Requests", proj: "Projection", real: "Mode: Real", demo: "Mode: Demo", lang: "Language: English" }
  };

  function getToken() {
    return localStorage.getItem('ws_token') || '';
  }

  function saveToken() {
    const v = document.getElementById('token-input').value.trim();
    if (!v) return alert('Introduce un token v谩lido');
    localStorage.setItem('ws_token', v);
    updateTokenUI();
    updateData();
  }

  function clearToken() {
    localStorage.removeItem('ws_token');
    document.getElementById('token-input').value = '';
    updateTokenUI();
    updateData();
  }

  function updateTokenUI() {
    const t = getToken();
    document.getElementById('token-status').innerText = t ? 's铆' : 'no';
    document.getElementById('token-input').value = t || '';
    document.getElementById('view-list-btn').disabled = !t;
    document.getElementById('download-list-btn').disabled = !t;
  }

  function toggleLang() {
    isEn = !isEn;
    refreshUI();
    updateData();
  }

  function toggleMode() {
    isDemo = !isDemo;
    document.getElementById('mode-btn').classList.toggle('active', !isDemo);
    refreshUI();
    updateData();
  }

  function refreshUI() {
    const p = isEn ? lang.en : lang.es;
    document.getElementById('lang-btn').innerText = " " + p.lang;
    document.getElementById('mode-btn').innerText = isDemo ? p.demo : p.real;
    document.getElementById('label-upd').innerText = p.upd;
    document.getElementById('label-req').innerText = p.req;
    document.getElementById('label-proj').innerText = p.proj;
  }

  async function updateData() {
    if (isDemo) {
      render(446, 1200, 850);
      return;
    }

    const token = getToken();
    if (!token) {
      document.getElementById('percent-text').innerText = isEn ? 'No token' : 'Sin token';
      document.getElementById('usage-text').innerText = '--';
      document.getElementById('req-val').innerText = '--';
      document.getElementById('proj-val').innerText = '--';
      document.getElementById('bar').style.width = '0%';
      return;
    }

    const api = "https://proxy.webshare.io/api/v2/proxy/stats/bandwidth/";
    // Use a CORS proxy only if necessary; this implementation uses corsproxy.io as before
    const url = "https://corsproxy.io/?" + encodeURIComponent(api);

    try {
      const res = await fetch(url, { headers: { 'Authorization': `Token ${token}` } });
      if (!res.ok) throw new Error('Network response was not ok');
      const data = await res.json();
      const used = Number((data.actual_usage || 0) / 1048576).toFixed(2);
      const requests = data.total_requests || "--";
      const projected = data.projected_usage ? Number(data.projected_usage / 1048576).toFixed(2) : "--";
      render(used, requests, projected);
    } catch (e) {
      console.error(e);
      document.getElementById('percent-text').innerText = isEn ? 'Error' : 'Error';
      document.getElementById('usage-text').innerText = '--';
    }
  }

  function render(used, req, proj) {
    const p = isEn ? lang.en : lang.es;
    const usedNum = Number(used) || 0;
    const percent = ((usedNum / 1024) * 100);
    const percentText = isNaN(percent) ? '0.0' : percent.toFixed(1);
    document.getElementById('bar').style.width = percentText + "%";
    document.getElementById('percent-text').innerText = percentText + "% " + p.used;
    document.getElementById('usage-text').innerText = usedNum.toFixed(2) + " MB / 1024 MB";
    document.getElementById('req-val').innerText = req;
    document.getElementById('proj-val').innerText = proj === "--" ? "--" : proj + " MB";
    document.getElementById('bar').style.background = percent > 80 ? "#ff5252" : "linear-gradient(90deg, #00c853, #b2ff59)";
  }

  function resetTimer() {
    clearInterval(timer);
    timer = setInterval(updateData, Number(document.getElementById('speed').value));
    updateData();
  }

  function proxyListUrlForToken(token) {
    // Build the download endpoint; token is sent as part of the URL per webshare current API
    return "https://proxy.webshare.io/api/v2/proxy/list/download/" + encodeURIComponent(token) + "/-/any/username/direct/-/?plan_id=12553212";
  }

  // Mostrar lista en pantalla (fetch y mostrar en textarea). Avoid opening a new tab with token in URL.
  async function mostrarLista() {
    const output = document.getElementById("proxy-output");
    const token = getToken();
    if (!token) return alert(isEn ? 'No token set' : 'No hay token');
    output.value = "Cargando lista...";

    const api = proxyListUrlForToken(token);
    const url = "https://corsproxy.io/?" + encodeURIComponent(api);

    try {
      const res = await fetch(url, { headers: { 'Authorization': `Token ${token}` } });
      if (!res.ok) throw new Error('Failed to fetch proxy list');
      const text = await res.text();
      output.value = text;
    } catch (e) {
      console.error(e);
      output.value = isEn ? 'Error al obtener la lista' : 'Error al obtener la lista';
    }
  }

  async function descargarLista() {
    const token = getToken();
    if (!token) return alert(isEn ? 'No token set' : 'No hay token');
    const api = proxyListUrlForToken(token);
    const url = "https://corsproxy.io/?" + encodeURIComponent(api);

    try {
      const res = await fetch(url, { headers: { 'Authorization': `Token ${token}` } });
      if (!res.ok) throw new Error('Failed to download');
      const blob = await res.blob();
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'webshare_proxies.txt';
      document.body.appendChild(link);
      link.click();
      link.remove();
    } catch (e) {
      console.error(e);
      alert(isEn ? 'Download failed' : 'Descarga fallida');
    }
  }

  // Initial setup
  refreshUI();
  updateTokenUI();
  resetTimer();
</script>
</body>
</html>